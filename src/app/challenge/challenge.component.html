<div class="challenge-page">

  <!-- ============================================
       HEADER WITH MODE SELECTOR
       ============================================ -->
  
  <div class="challenge-header">
    <div class="challenge-badge">
      <i class="fa-solid fa-trophy"></i>
    </div>
    <h2 class="challenge-title">Challenge Mode</h2>
    <p class="challenge-subtitle">{{ challengeSet?.displayName || 'Loading...' }}</p>
  </div>

  <!-- ============================================
       MODE SELECTOR TABS
       ============================================ -->

  <div class="mode-selector" *ngIf="challengeSet">
    <button
      *ngFor="let mode of modes"
      class="mode-tab"
      [class.active]="currentMode === mode"
      [class.completed]="isModeCompleted(mode)"
      [class.locked]="!isModeUnlocked(mode)"
      [disabled]="!isModeUnlocked(mode)"
      (click)="switchMode(mode)"
      [title]="!isModeUnlocked(mode) ? getModeLockReason(mode) : ''">
      
      <span class="mode-icon">{{ getModeIcon(mode) }}</span>
      <span class="mode-name">{{ getModeTitle(mode) }}</span>
      
      <span class="mode-status" *ngIf="isModeCompleted(mode)">
        <i class="fa-solid fa-check"></i>
      </span>
      <span class="mode-status" *ngIf="!isModeUnlocked(mode)">
        <i class="fa-solid fa-lock"></i>
      </span>
    </button>
  </div>

  <!-- ============================================
       PROGRESS BAR
       ============================================ -->

  <div class="progress-container" *ngIf="currentMode !== 'construct' && currentModeData && totalQuestions !== 0 && !showModeCompletion">
    <div class="progress-label">
      <span>Question {{ currentQuestionIndex + 1 }} of {{ totalQuestions }}</span>
      <span>{{ progressPercentage.toFixed(0) }}%</span>
    </div>
    <div class="progress-track">
      <div class="progress-fill" [style.width.%]="progressPercentage"></div>
    </div>
  </div>

  <!-- ============================================
       QUESTION CARD
       ============================================ -->

  <div class="challenge-card" *ngIf="currentMode !== 'construct' && currentQuestion && totalQuestions !== 0 && !showModeCompletion">
    
    <div class="challenge-question">
      {{ currentQuestion.prompt }}
    </div>

    <div class="challenge-options">
      <button
        *ngFor="let option of currentQuestion.options"
        class="challenge-option-btn"
        [class.selected]="selectedAnswer === option.value"
        [class.correct]="isCorrect && selectedAnswer === option.value"
        [class.incorrect]="!isCorrect && selectedAnswer === option.value"
        [disabled]="selectedAnswer !== null || isQuestionLocked"
        (click)="submitAnswer(option.value)">
        
        <span class="option-icon">
          <i class="fa-solid fa-arrow-right"></i>
        </span>
        <span class="option-text">{{ option.label }}</span>
      </button>
    </div>

    <!-- Feedback -->
    <div class="challenge-feedback" *ngIf="feedback">
      <div class="feedback-content" [class.correct]="isCorrect" [class.incorrect]="!isCorrect">
        {{ feedback }}
      </div>
    </div>

    <div class="challenge-hint" *ngIf="showHint && currentQuestion.hint">
      üí° Hint: {{ currentQuestion.hint }}
    </div>

    <!-- Explanation -->
    <div class="challenge-explanation" *ngIf="explanation">
      <p>{{ explanation }}</p>
    </div>

    <button
      class="action-btn primary"
      *ngIf="canProceedAfterFailure"
      (click)="nextQuestion()">
      Continue
    </button>

  </div>

  <!-- ============================================
       CONSTRUCT MODE
       ============================================ -->

  <div class="construct-section"
       *ngIf="currentMode === 'construct' && !showModeCompletion">

    <div class="construct-header">
      <h3>Construct Challenge</h3>
      <p>Place queens row by row without conflicts.</p>
    </div>

    <!-- BOARD -->
    <div class="construct-board">
      <div
        class="construct-row"
        *ngFor="let r of constructBoard; let rowIndex = index">

        <div
          class="construct-cell"
          *ngFor="let c of constructBoard; let colIndex = index"
          (click)="rowIndex === constructCurrentRow && onConstructCellClick(rowIndex, colIndex)"
          [class.queen]="constructBoard[rowIndex] === colIndex"
          [class.conflict-path]="constructAttackCells.has(rowIndex + '-' + colIndex)"
          [class.active-row]="rowIndex === constructCurrentRow"
          [class.shaking]="isShaking(rowIndex, colIndex)">

          <span *ngIf="constructBoard[rowIndex] === colIndex">‚ôõ</span>

        </div>
      </div>
    </div>

    <!-- STATUS ‚Äî only shows on success, no failure message -->
    <div class="construct-status">
      <p *ngIf="constructStatus === 'success'" class="success">
        ‚úì Valid solution found!
      </p>
    </div>

    <!-- SMART BACKTRACK HINT ‚Äî appears only when board is provably stuck -->
    <div class="construct-hint" *ngIf="showBacktrackHint && constructStatus === 'playing'">
      <span class="hint-icon">ü§î</span>
      <span class="hint-text">
        Hmm... this path seems stuck. Maybe try backtracking?
      </span>
    </div>

    <!-- CONTROLS -->
    <div class="construct-controls">
      <button
        class="action-btn secondary"
        (click)="backtrack()"
        [disabled]="constructCurrentRow === 0">
        ‚Üê Backtrack
      </button>

      <button
        class="action-btn primary"
        (click)="resetConstruct()">
        Restart
      </button>
    </div>

  </div>


  <!-- ============================================
       MODE COMPLETION
       ============================================ -->

  <div class="mode-completion" *ngIf="showModeCompletion">
    <div class="completion-icon">
      <i class="fa-solid fa-circle-check"></i>
    </div>
    
    <h2 class="completion-title">
      {{ getModeTitle(currentMode) }} Completed! üéâ
    </h2>
    
    <p class="completion-message">
      <ng-container *ngIf="currentMode === 'quiz'">
        You've mastered the concepts! Ready to trace the algorithm step-by-step?
      </ng-container>
      <ng-container *ngIf="currentMode === 'trace'">
        Excellent execution tracing! Now test your predictive skills.
      </ng-container>
      <ng-container *ngIf="currentMode === 'predict'">
        Ready to execute it yourself? Try Construct mode next.
      </ng-container>
      <ng-container *ngIf="currentMode === 'construct'">
        You've successfully constructed a valid solution! Great job!
      </ng-container>
    </p>

    <div class="completion-actions">
      <button 
        class="action-btn primary"
        *ngIf="currentMode !== 'construct'"
        (click)="continueToNextMode()">
        Continue to {{ currentMode === 'quiz' ? 'Trace' :
         currentMode === 'trace' ? 'Predict' : 'Construct' }} Mode
        <i class="fa-solid fa-arrow-right"></i>
      </button>

      <button 
        class="action-btn secondary"
        (click)="goBackToLearning()">
        <i class="fa-solid fa-arrow-left"></i>
        Back to Learning
      </button>
    </div>
  </div>

</div>