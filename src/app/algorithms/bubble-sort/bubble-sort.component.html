<div class="visualizer-container">
  
  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button class="tab-btn" 
            [class.active]="activeTab === 'overview'"
            (click)="activeTab = 'overview'">
      <span class="tab-icon"><i class="fa-solid fa-book-open"></i></span>
      Overview
    </button>
    <button class="tab-btn" 
            [class.active]="activeTab === 'visualization'"
            (click)="activeTab = 'visualization'">
      <span class="tab-icon"><i class="fa-solid fa-play"></i></span>
      Visualization
    </button>
    <button class="tab-btn" 
            [class.active]="activeTab === 'complexity'"
            (click)="activeTab = 'complexity'">
      <span class="tab-icon"><i class="fa-solid fa-chart-line"></i></span>
      Complexity
    </button>
  </div>

  <!-- TAB 1: OVERVIEW -->
  <div class="tab-content" *ngIf="activeTab === 'overview'">
    <div class="overview-container">
      <div class="overview-hero">
        <h1 class="overview-title">{{algorithmMeta?.name || "Bubble Sort"}}</h1>
        <p class="overview-subtitle">Repeatedly swap adjacent elements if they're in the wrong order.</p>
      </div>

      <div class="overview-content">
        <div class="overview-section">
          <div class="section-icon"><i class="fa-solid fa-arrow-up-arrow-down"></i></div>
          <h2>What is it?</h2>
          <p>{{algorithmMeta?.short_description || "Bubble Sort works by repeatedly stepping through the list, comparing adjacent elements and swapping them if they're in the wrong order. The largest elements 'bubble up' to their correct positions."}}</p>
        </div>

        <div class="overview-section">
          <div class="section-icon"><i class="fa-solid fa-bullseye"></i></div>
          <h2>When to use it?</h2>
          <ul class="feature-list">
            <li><strong>Educational purposes</strong> — Great for learning sorting concepts</li>
            <li><strong>Small datasets</strong> — Works adequately for very short lists</li>
            <li><strong>Nearly sorted data</strong> — Can detect if data is already sorted early</li>
          </ul>
        </div>

        <div class="key-idea-box">
          <div class="key-idea-header">
            <span class="lightbulb"><i class="fa-solid fa-lightbulb"></i></span>
            <span>Key Insight</span>
          </div>
          <p>After each pass through the array, the largest unsorted element "bubbles" to its correct position at the end. This means you need fewer comparisons with each successive pass!</p>
        </div>

        <div class="cta-box">
          <p>Ready to see it in action?</p>
          <button class="cta-button" (click)="activeTab = 'visualization'">
            Watch the Visualization →
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 2: VISUALIZATION -->
  <div class="tab-content" *ngIf="activeTab === 'visualization'">
    <div class="split-container">

      <!-- LEFT: Code Panel -->
      <div class="code-panel" [style.width.%]="codePanelWidth">
        <div class="panel-header">
          <div class="header-title">
            <span class="code-icon">&lt;/&gt;</span>
            <h3>Algorithm Code</h3>
          </div>
          <div class="language-badge">Python</div>
        </div>

        <div class="code-content" #codeScroller>
          <pre class="code-block"><code><span class="code-line" 
      [class.active]="isLineActive(1)" 
      [class.dim]="!isLineActive(1) && currentStep"
      #line1><span class="line-number">1</span><span class="keyword">def</span> <span class="function">bubble_sort</span>(arr):</span>
<span class="code-line" 
      [class.active]="isLineActive(2)" 
      [class.dim]="!isLineActive(2) && currentStep"
      #line2><span class="line-number">2</span>    n = <span class="function">len</span>(arr)</span>
<span class="code-line" 
      [class.active]="isLineActive(3)" 
      [class.dim]="!isLineActive(3) && currentStep"
      #line3><span class="line-number">3</span>    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="function">range</span>(n):</span>
<span class="code-line" 
      [class.active]="isLineActive(4)" 
      [class.dim]="!isLineActive(4) && currentStep"
      #line4><span class="line-number">4</span>        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="function">range</span>(<span class="number">0</span>, n - i - <span class="number">1</span>):</span>
<span class="code-line" 
      [class.active]="isLineActive(5)" 
      [class.dim]="!isLineActive(5) && currentStep"
      #line5><span class="line-number">5</span>            <span class="keyword">if</span> arr[j] > arr[j + <span class="number">1</span>]:</span>
<span class="code-line" 
      [class.active]="isLineActive(6)" 
      [class.dim]="!isLineActive(6) && currentStep"
      #line6><span class="line-number">6</span>                arr[j], arr[j + <span class="number">1</span>] = arr[j + <span class="number">1</span>], arr[j]</span>
<span class="code-line" 
      [class.active]="isLineActive(7)" 
      [class.dim]="!isLineActive(7) && currentStep"
      #line7><span class="line-number">7</span>    <span class="keyword">return</span> arr</span></code></pre>

          @if (currentStep) {
            <div class="live-explanation">
              <div class="explanation-header">
                <span class="explanation-icon"><i class="fa-solid fa-lightbulb"></i></span>
                <span class="explanation-title">What's happening?</span>
              </div>
              <p class="explanation-text">{{ getLineExplanation(currentStep.line) }}</p>
            </div>
          }

          <div class="complexity-info">
            <div class="complexity-item">
              <span class="complexity-label">Time Complexity</span>
              <span class="complexity-value">{{algorithmMeta?.time_complexity || 'O(n²)'}}</span>
            </div>
            <div class="complexity-item">
              <span class="complexity-label">Space Complexity</span>
              <span class="complexity-value">{{algorithmMeta?.space_complexity || 'O(1)'}}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Resizer -->
      <div class="resizer"
           (mousedown)="onResizerMouseDown($event)"
           (touchstart)="onResizerTouchStart($event)">
        <div class="resizer-line"></div>
        <div class="resizer-handle">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <circle cx="4" cy="8" r="1.5"/>
            <circle cx="8" cy="8" r="1.5"/>
            <circle cx="12" cy="8" r="1.5"/>
          </svg>
        </div>
      </div>

      <!-- RIGHT: Visualization Panel -->
      <div class="visualization-panel" [style.width.%]="100 - codePanelWidth">

        <div class="panel-header" [class.compact]="steps.length > 0">
          <div class="header-title">
            <span class="viz-icon">▶</span>
            <h3>Live Visualization</h3>
          </div>

          @if (steps.length > 0) {
            <div class="input-controls-compact">
              <span class="input-display">Array: {{ arrayInput }}</span>
              <button class="edit-button" (click)="resetToEdit()"><i class="fa-duotone fa-solid fa-pen-to-square"></i> Edit</button>
            </div>
          }
        </div>

        <div class="viz-content">

          @if (currentStep) {
            <div class="animation-area">

              <div class="status-bar">
                <div class="status-left">
                  <div class="status-icon"
                       [style.color]="getActionColor(currentStep.action)">
                    {{ getActionIcon(currentStep.action) }}
                  </div>

                  <div class="status-info">
                    <div class="status-message">
                      {{ currentStep.message }}
                    </div>

                    @if (currentStep.action !== 'complete' && (currentStep.variables.i !== undefined || currentStep.variables.j !== undefined)) {
                      <div class="status-detail">
                        @if (currentStep.variables.i !== undefined) {
                          Pass
                          <span class="highlight">
                            {{ currentStep.variables.i + 1 }}
                          </span>
                        }
                        @if (currentStep.variables.j !== undefined) {
                          · Position
                          <span class="highlight">
                            {{ currentStep.variables.j }}
                          </span>
                        }
                      </div>
                    }
                  </div>
                </div>

                <div class="status-badge"
                     [style.background]="getActionColor(currentStep.action)">
                  {{ getActionLabel(currentStep.action) }}
                </div>
              </div>

              @if (currentStep.action === 'compare' && currentStep.variables.j !== undefined) {
                <div class="comparison-display">
                  <div class="compare-item current">
                    <span class="compare-label">Index {{ currentStep.variables.j }}</span>
                    <span class="compare-value">
                      {{ currentStep.data[currentStep.variables.j] }}
                    </span>
                  </div>

                  <div class="compare-operator">{{ currentStep.data[currentStep.variables.j] > currentStep.data[currentStep.variables.j + 1] ? '>' : '≤' }}</div>

                  <div class="compare-item target">
                    <span class="compare-label">Index {{ currentStep.variables.j + 1 }}</span>
                    <span class="compare-value">{{ currentStep.data[currentStep.variables.j + 1] }}</span>
                  </div>
                </div>
              }

              <div class="array-display">
                @for (item of currentStep.data; track $index; let idx = $index) {
                  <div class="array-cell-wrapper">
                    <div class="cell-index">{{ idx }}</div>

                    <div class="array-cell"
                         [class.active]="isComparingIndex(idx)"
                         [class.swapping]="isSwappingIndex(idx)"
                         [class.sorted]="isSorted(idx) || currentStep.action === 'complete'">
                      <span class="cell-value">{{ item }}</span>

                      @if (isComparingIndex(idx) && currentStep.action !== 'complete') {
                        <div class="cell-glow"></div>
                      }
                    </div>

                    @if (isComparingIndex(idx) && currentStep.action !== 'complete') {
                      <div class="pointer">
                        <div class="pointer-arrow">▼</div>
                      </div>
                    }
                  </div>
                }
              </div>

              <div class="progress-section">
                <div class="progress-label">
                  <span>Step {{ currentStepIndex + 1 }} of {{ steps.length }}</span>
                  <span>{{ progressPercentage.toFixed(0) }}%</span>
                </div>

                <div class="progress-track">
                  <div class="progress-fill"
                       [style.width.%]="progressPercentage"
                       [style.background]="getActionColor(currentStep.action)">
                  </div>
                </div>
              </div>

            </div>
          }

          @if (!currentStep) {
            <div class="input-center-state">
              <div class="input-card">
                <h3>Configure Your Sort</h3>
                <p class="input-subtitle">Enter an array to visualize the sorting process</p>

                <div class="input-form">
                  <div class="form-group">
                    <label>Array (comma-separated)</label>
                    <input type="text"
                           [(ngModel)]="arrayInput"
                           placeholder="64, 34, 25, 12, 22, 11, 90"
                           class="input-field" />
                  </div>

                  <button class="run-button-large" (click)="runSort()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                    Run Visualization
                  </button>
                </div>
              </div>
            </div>
          }

        </div>

        @if (steps.length > 0) {
          <div class="control-panel">

            <div class="playback-controls">
              <button class="ctrl-btn" (click)="handleReset()" title="Reset">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                  <path d="M21 3v5h-5"/>
                </svg>
              </button>

              <button class="ctrl-btn"
                      (click)="handlePrevious()"
                      [disabled]="currentStepIndex === 0"
                      title="Previous">
                ◀
              </button>

              <button class="ctrl-btn play-btn"
                      (click)="handlePlayPause()"
                      title="Play/Pause">
                {{ isPlaying ? '❚❚' : '▶' }}
              </button>

              <button class="ctrl-btn"
                      (click)="handleNext()"
                      [disabled]="currentStepIndex >= steps.length - 1"
                      title="Next">
                ▶
              </button>
            </div>

            <div class="speed-control">
              <span class="speed-label">Speed</span>
              <input type="range"
                     min="200"
                     max="2000"
                     step="100"
                     [(ngModel)]="speed"
                     (input)="onSpeedChange()"
                     class="speed-slider" />
              <span class="speed-value">{{ getSpeedLabel() }}</span>
            </div>

          </div>
        }

      </div>
    </div>
  </div>

  <!-- TAB 3: COMPLEXITY -->
  <div class="tab-content" *ngIf="activeTab === 'complexity'">
    <div class="complexity-container">
      
      <div class="complexity-hero">
        <h1 class="complexity-title">Performance Analysis</h1>
        <p class="complexity-subtitle">Understanding how {{algorithmMeta?.name || 'Bubble Sort'}} performs</p>
      </div>

      <div class="complexity-grid">
        
        <!-- Time Complexity Card -->
        <div class="complexity-card time-card">
          <div class="card-header">
            <div class="card-icon"><i class="fa-regular fa-stopwatch"></i></div>
            <h2>Time Complexity</h2>
          </div>
          <div class="big-o">{{algorithmMeta?.time_complexity || 'O(n²)'}}</div>
          <div class="card-content">
            <h3>What does this mean?</h3>
            <p>The time it takes grows <strong>quadratically</strong> with the size of the array. If you double the array size, the sort time increases by roughly 4 times.</p>
            
            <h3>Why {{algorithmMeta?.time_complexity || 'O(n²)'}}?</h3>
            <p>In the worst-case scenario:</p>
            <ul>
              <li>The outer loop runs <strong>n times</strong> (one for each element)</li>
              <li>The inner loop runs <strong>up to n times</strong> for each outer iteration</li>
              <li>This gives us n × n = n² comparisons</li>
            </ul>
            <p>For an array of size n, we make approximately n²/2 comparisons and swaps in the worst case.</p>

            <div class="example-box">
              <div class="example-title">Real-world example</div>
              <p>Sorting 10 cards takes ~50 comparisons. Sorting 100 cards? That's ~5,000 comparisons! The growth is exponential.</p>
            </div>
          </div>
        </div>

        <!-- Space Complexity Card -->
        <div class="complexity-card space-card">
          <div class="card-header">
            <div class="card-icon"><i class="fa-duotone fa-regular fa-floppy-disk"></i></div>
            <h2>Space Complexity</h2>
          </div>
          <div class="big-o">{{algorithmMeta?.space_complexity || 'O(1)'}}</div>
          <div class="card-content">
            <h3>What does this mean?</h3>
            <p>Bubble Sort uses a <strong>constant</strong> amount of extra memory, regardless of the input array size.</p>

            <h3>Why {{algorithmMeta?.space_complexity || 'O(1)'}}?</h3>
            <p>We only need:</p>
            <ul>
              <li>A few variables to track <strong>loop indices</strong> (i, j)</li>
              <li>A temporary variable for <strong>swapping</strong></li>
              <li>No additional arrays or data structures</li>
            </ul>
            <p>Bubble Sort is an "in-place" sorting algorithm, meaning it sorts the array without needing extra space proportional to input size.</p>

            <div class="example-box">
              <div class="example-title">Real-world example</div>
              <p>Like organizing books on a shelf by repeatedly swapping adjacent ones. You don't need an extra shelf!</p>
            </div>
          </div>
        </div>

      </div>

      <!-- Comparison Table -->
      <div class="comparison-section">
        <h2>How does it compare?</h2>
        <table class="comparison-table">
          <thead>
            <tr>
              <th>Scenario</th>
              <th>Time Complexity</th>
              <th>When it happens</th>
            </tr>
          </thead>
          <tbody>
            <tr class="best-case">
              <td><strong>Best Case</strong></td>
              <td>{{algorithmMeta?.best_case || 'O(n)'}}</td>
              <td>Array is already sorted (with optimization)</td>
            </tr>
            <tr class="average-case">
              <td><strong>Average Case</strong></td>
              <td>{{algorithmMeta?.average_case || 'O(n²)'}}</td>
              <td>Elements in random order</td>
            </tr>
            <tr class="worst-case">
              <td><strong>Worst Case</strong></td>
              <td>{{algorithmMeta?.worst_case || 'O(n²)'}}</td>
              <td>Array is sorted in reverse order</td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

</div>